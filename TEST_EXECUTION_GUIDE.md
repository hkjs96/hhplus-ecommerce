# ì„ ì°©ìˆœ ì¿ í° ì˜ˆì•½ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ê°€ì´ë“œ

## ğŸ“‹ í…ŒìŠ¤íŠ¸ ê°œìš”

STEP 14 ì„ ì°©ìˆœ ì¿ í° ì˜ˆì•½ ì‹œìŠ¤í…œì˜ ë™ì‹œì„± ë° í†µí•© í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.

### í…ŒìŠ¤íŠ¸ íŒŒì¼

1. **CouponReservationConcurrencyTest.java** - ë™ì‹œì„± í…ŒìŠ¤íŠ¸
   - 1000ëª… ë™ì‹œ ìš”ì²­ â†’ 100ê°œë§Œ ì„±ê³µ
   - ì¬ê³  ë¶€ì¡± ì‹œë‚˜ë¦¬ì˜¤ (200ëª… â†’ 50ê°œ)
   - ì¤‘ë³µ ì˜ˆì•½ ë°©ì§€

2. **CouponReservationIntegrationTest.java** - í†µí•© í…ŒìŠ¤íŠ¸
   - ì˜ˆì•½ â†’ ë°œê¸‰ ì™„ë£Œ í”Œë¡œìš°
   - ë‹¤ìˆ˜ ì‚¬ìš©ì ìˆœì°¨ ì˜ˆì•½
   - Redis-DB ì¼ê´€ì„± ê²€ì¦

---

## ğŸš€ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë°©ë²•

### 1. ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰

```bash
./gradlew test --tests "io.hhplus.ecommerce.application.usecase.coupon.CouponReservation*"
```

### 2. ë™ì‹œì„± í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰

```bash
./gradlew test --tests "io.hhplus.ecommerce.application.usecase.coupon.CouponReservationConcurrencyTest"
```

### 3. í†µí•© í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰

```bash
./gradlew test --tests "io.hhplus.ecommerce.application.usecase.coupon.CouponReservationIntegrationTest"
```

### 4. íŠ¹ì • í…ŒìŠ¤íŠ¸ ë©”ì„œë“œë§Œ ì‹¤í–‰

```bash
# 1000ëª… ë™ì‹œì„± í…ŒìŠ¤íŠ¸
./gradlew test --tests "io.hhplus.ecommerce.application.usecase.coupon.CouponReservationConcurrencyTest.ì„ ì°©ìˆœ_ì¿ í°_ì˜ˆì•½_ë™ì‹œì„±_í…ŒìŠ¤íŠ¸_1000ëª…"

# ì˜ˆì•½ â†’ ë°œê¸‰ í”Œë¡œìš° í…ŒìŠ¤íŠ¸
./gradlew test --tests "io.hhplus.ecommerce.application.usecase.coupon.CouponReservationIntegrationTest.ì˜ˆì•½_ë°œê¸‰_ì™„ë£Œ_í”Œë¡œìš°_í…ŒìŠ¤íŠ¸"
```

---

## ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ í™•ì¸

### 1. ì½˜ì†” ì¶œë ¥

í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘ ì½˜ì†”ì— ì‹¤ì‹œê°„ ê²°ê³¼ê°€ ì¶œë ¥ë©ë‹ˆë‹¤:

```
================================================================================
í…ŒìŠ¤íŠ¸ ê²°ê³¼ (1000ëª… ìš”ì²­)
================================================================================
ì„±ê³µ: 100 / ì‹¤íŒ¨: 900
Redis Sequence: 1000
CouponReservation: 100
UserCoupon: 100
Coupon.issuedQuantity: 100
ì‹¤í–‰ ì‹œê°„: 3542ms
ë¡œê·¸ íŒŒì¼: build/test-results/coupon-reservation-concurrency/test_1000_requests_2025-12-04_14-30-15.log
================================================================================
```

### 2. ë¡œê·¸ íŒŒì¼

í…ŒìŠ¤íŠ¸ ì‹¤í–‰ í›„ ìƒì„¸ ë¡œê·¸ íŒŒì¼ì´ ìƒì„±ë©ë‹ˆë‹¤:

```
build/test-results/
â”œâ”€â”€ coupon-reservation-concurrency/
â”‚   â”œâ”€â”€ test_1000_requests_2025-12-04_14-30-15.log
â”‚   â”œâ”€â”€ test_200_requests_50_stock_2025-12-04_14-30-20.log
â”‚   â””â”€â”€ test_duplicate_prevention_2025-12-04_14-30-25.log
â””â”€â”€ coupon-reservation-integration/
    â”œâ”€â”€ test_reservation_flow_2025-12-04_14-30-30.log
    â”œâ”€â”€ test_multiple_users_2025-12-04_14-30-35.log
    â””â”€â”€ test_redis_db_consistency_2025-12-04_14-30-40.log
```

### 3. ë¡œê·¸ íŒŒì¼ ë‚´ìš© ì˜ˆì‹œ

```
================================================================================
ì„ ì°©ìˆœ ì¿ í° ì˜ˆì•½ ë™ì‹œì„± í…ŒìŠ¤íŠ¸
================================================================================
í…ŒìŠ¤íŠ¸ ì‹œì‘: 2025-12-04T14:30:15
ì¿ í° ID: 123
ì´ ìˆ˜ëŸ‰: 100
ë™ì‹œ ìš”ì²­ ìˆ˜: 1000
ì˜ˆìƒ ì„±ê³µ: 100
================================================================================

[SUCCESS] User 0 (ID: 456) - ì˜ˆì•½ ì„±ê³µ (1ë²ˆì§¸)
[SUCCESS] User 5 (ID: 461) - ì˜ˆì•½ ì„±ê³µ (2ë²ˆì§¸)
...
[SOLD_OUT] User 150 - ì¿ í°ì´ ëª¨ë‘ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤. (150/100)
...

================================================================================
í…ŒìŠ¤íŠ¸ ê²°ê³¼
================================================================================
ì´ ì‹¤í–‰ ì‹œê°„: 3542ms

[ìš”ì²­ í†µê³„]
  - ì´ ìš”ì²­: 1000
  - ì„±ê³µ: 100
  - ì‹¤íŒ¨: 900
    * ìˆ˜ëŸ‰ ì´ˆê³¼: 900
    * ì¤‘ë³µ ì˜ˆì•½: 0
    * ê¸°íƒ€ ì—ëŸ¬: 0

[ë°ì´í„° ê²€ì¦]
  - Redis Sequence: 1000
  - CouponReservation ê±´ìˆ˜: 100
  - UserCoupon ê±´ìˆ˜: 100
  - Coupon.issuedQuantity: 100

[ê²€ì¦ ê²°ê³¼]
  - ì„±ê³µ ê±´ìˆ˜ ì¼ì¹˜: âœ… PASS
  - ì‹¤íŒ¨ ê±´ìˆ˜ ì¼ì¹˜: âœ… PASS
  - ì˜ˆì•½ ê±´ìˆ˜ ì¼ì¹˜: âœ… PASS
  - Redis ìˆœë²ˆ ìœ íš¨: âœ… PASS

================================================================================
í…ŒìŠ¤íŠ¸ ì¢…ë£Œ: 2025-12-04T14:30:19
================================================================================
```

---

## ğŸ” í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ìƒì„¸

### ë™ì‹œì„± í…ŒìŠ¤íŠ¸ 1: 1000ëª… â†’ 100ê°œ

**ëª©ì :** Redis INCRì˜ ì›ìì„± ê²€ì¦

**ì‹œë‚˜ë¦¬ì˜¤:**
1. ì„ ì°©ìˆœ 100ê°œ ì¿ í° ìƒì„±
2. 1000ëª…ì´ ë™ì‹œì— ì˜ˆì•½ ìš”ì²­
3. ì •í™•íˆ 100ëª…ë§Œ ì„±ê³µ, 900ëª… ì‹¤íŒ¨

**ê²€ì¦ í•­ëª©:**
- âœ… ì„±ê³µ ê±´ìˆ˜ = 100
- âœ… ì‹¤íŒ¨ ê±´ìˆ˜ = 900
- âœ… CouponReservation ê±´ìˆ˜ = 100
- âœ… Redis sequence >= 100
- âœ… UserCoupon ê±´ìˆ˜ = 100 (Event ì²˜ë¦¬ í›„)
- âœ… Coupon.issuedQuantity = 100

---

### ë™ì‹œì„± í…ŒìŠ¤íŠ¸ 2: ì¬ê³  ë¶€ì¡±

**ëª©ì :** ì¬ê³ ë³´ë‹¤ ë§ì€ ìš”ì²­ ì²˜ë¦¬

**ì‹œë‚˜ë¦¬ì˜¤:**
1. ì„ ì°©ìˆœ 50ê°œ ì¿ í° ìƒì„±
2. 200ëª…ì´ ë™ì‹œì— ì˜ˆì•½ ìš”ì²­
3. ì •í™•íˆ 50ëª…ë§Œ ì„±ê³µ, 150ëª… ì‹¤íŒ¨

**ê²€ì¦ í•­ëª©:**
- âœ… ì„±ê³µ ê±´ìˆ˜ = 50
- âœ… ì‹¤íŒ¨ ê±´ìˆ˜ = 150
- âœ… ì¬ê³  ì •í™•íˆ 0ê°œ

---

### ë™ì‹œì„± í…ŒìŠ¤íŠ¸ 3: ì¤‘ë³µ ì˜ˆì•½ ë°©ì§€

**ëª©ì :** ê°™ì€ ì‚¬ìš©ìì˜ ì¤‘ë³µ ìš”ì²­ ì°¨ë‹¨

**ì‹œë‚˜ë¦¬ì˜¤:**
1. ê°™ì€ ì‚¬ìš©ìê°€ 10ë²ˆ ì˜ˆì•½ ì‹œë„
2. 1ë²ˆë§Œ ì„±ê³µ, 9ë²ˆ ì¤‘ë³µ ì°¨ë‹¨

**ê²€ì¦ í•­ëª©:**
- âœ… ì„±ê³µ ê±´ìˆ˜ = 1
- âœ… ì¤‘ë³µ ì°¨ë‹¨ = 9
- âœ… DB ì˜ˆì•½ ê±´ìˆ˜ = 1

---

### í†µí•© í…ŒìŠ¤íŠ¸ 1: ì˜ˆì•½ â†’ ë°œê¸‰ í”Œë¡œìš°

**ëª©ì :** ì „ì²´ í”Œë¡œìš° ê²€ì¦

**ë‹¨ê³„:**
1. ì˜ˆì•½ ìš”ì²­ (ReserveCouponUseCase)
2. CouponReservation ìƒì„± í™•ì¸
3. Redis sequence í™•ì¸
4. Event Listener ì²˜ë¦¬ ëŒ€ê¸°
5. UserCoupon ìƒì„± í™•ì¸
6. Coupon ì¬ê³  ì°¨ê° í™•ì¸
7. CouponReservation ìƒíƒœ ì—…ë°ì´íŠ¸ í™•ì¸ (ISSUED)

---

### í†µí•© í…ŒìŠ¤íŠ¸ 2: ë‹¤ìˆ˜ ì‚¬ìš©ì

**ëª©ì :** ìˆœì°¨ ì˜ˆì•½ â†’ ëª¨ë‘ ë°œê¸‰ ê²€ì¦

**ì‹œë‚˜ë¦¬ì˜¤:**
1. 10ëª…ì´ ìˆœì°¨ì ìœ¼ë¡œ ì˜ˆì•½
2. ëª¨ë‘ ë°œê¸‰ ì™„ë£Œ í™•ì¸

---

### í†µí•© í…ŒìŠ¤íŠ¸ 3: Redis-DB ì¼ê´€ì„±

**ëª©ì :** ë°ì´í„° ì •í•©ì„± ê²€ì¦

**ê²€ì¦:**
- Redis sequenceì™€ DB ê±´ìˆ˜ ì¼ì¹˜
- Redis issued setê³¼ UserCoupon ê±´ìˆ˜ ì¼ì¹˜
- Coupon.issuedQuantity ì •í™•ì„±

---

## ğŸ› ë¬¸ì œ í•´ê²°

### 1. Redis ì—°ê²° ì‹¤íŒ¨

**ì¦ìƒ:**
```
Cannot get Jedis connection
```

**í•´ê²°:**
- Dockerë¡œ Redis ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
- Testcontainersê°€ ìë™ìœ¼ë¡œ Redisë¥¼ ì‹œì‘í•˜ë¯€ë¡œ ë³„ë„ ì‹¤í–‰ ë¶ˆí•„ìš”

---

### 2. í…ŒìŠ¤íŠ¸ íƒ€ì„ì•„ì›ƒ

**ì¦ìƒ:**
```
Test timed out after 60000 milliseconds
```

**í•´ê²°:**
- HikariCP connection pool ì„¤ì • í™•ì¸
- `TestContainersConfig.java`ì—ì„œ pool size ì¦ê°€

---

### 3. Event Listener ë¯¸ì²˜ë¦¬

**ì¦ìƒ:**
- CouponReservationì€ ìƒì„±ë˜ì—ˆì§€ë§Œ UserCouponì´ ì—†ìŒ

**ì›ì¸:**
- Event Listenerê°€ ë¹„ë™ê¸°ë¡œ ì‹¤í–‰ë˜ë¯€ë¡œ ëŒ€ê¸° ì‹œê°„ í•„ìš”

**í•´ê²°:**
- í…ŒìŠ¤íŠ¸ì— `Thread.sleep(2000)` ì´ë¯¸ í¬í•¨ë¨
- ë” ê¸´ ëŒ€ê¸° ì‹œê°„ í•„ìš” ì‹œ sleep ì‹œê°„ ì¦ê°€

---

## ğŸ“ˆ ì„±ëŠ¥ ì¸¡ì •

í…ŒìŠ¤íŠ¸ ë¡œê·¸ì—ì„œ ë‹¤ìŒ ì„±ëŠ¥ ì§€í‘œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

- **ì´ ì‹¤í–‰ ì‹œê°„**: 1000ëª… ë™ì‹œ ìš”ì²­ ì²˜ë¦¬ ì‹œê°„
- **ì˜ˆì•½ ì‹œê°„**: ë‹¨ì¼ ì˜ˆì•½ ìš”ì²­ ì²˜ë¦¬ ì‹œê°„
- **ë°œê¸‰ ì‹œê°„**: Event Listener ì²˜ë¦¬ ì‹œê°„

**ì˜ˆìƒ ì„±ëŠ¥:**
- 1000ëª… ë™ì‹œ ìš”ì²­: 3-5ì´ˆ
- ë‹¨ì¼ ì˜ˆì•½: 10-50ms
- Event ì²˜ë¦¬ ëŒ€ê¸°: 2-3ì´ˆ

---

## âœ… í…ŒìŠ¤íŠ¸ ì„±ê³µ ê¸°ì¤€

### ë™ì‹œì„± í…ŒìŠ¤íŠ¸

- [ ] 1000ëª… ìš”ì²­ â†’ ì •í™•íˆ 100ëª… ì„±ê³µ
- [ ] ì‹¤íŒ¨ ê±´ìˆ˜ = 900
- [ ] Redis sequence >= 100
- [ ] CouponReservation ê±´ìˆ˜ = 100
- [ ] UserCoupon ê±´ìˆ˜ = 100
- [ ] Coupon.issuedQuantity = 100

### í†µí•© í…ŒìŠ¤íŠ¸

- [ ] ì˜ˆì•½ í›„ UserCoupon ìƒì„±
- [ ] Coupon ì¬ê³  ì •í™•íˆ ì°¨ê°
- [ ] CouponReservation ìƒíƒœ = ISSUED
- [ ] Redis-DB ë°ì´í„° ì¼ì¹˜

---

## ğŸ“ ë¡œê·¸ ì œê³µ ë°©ë²•

Claudeì—ê²Œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ì œê³µí•  ë•Œ:

1. **ì½˜ì†” ì¶œë ¥ ë³µì‚¬**
   ```bash
   ./gradlew test --tests "..." > test-output.log 2>&1
   ```

2. **ë¡œê·¸ íŒŒì¼ ë³µì‚¬**
   ```bash
   cat build/test-results/coupon-reservation-concurrency/test_1000_requests_*.log
   ```

3. **ì „ì²´ í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸**
   ```bash
   ./gradlew test
   open build/reports/tests/test/index.html
   ```

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„

í…ŒìŠ¤íŠ¸ ì„±ê³µ í›„:

1. âœ… ë™ì‹œì„± í…ŒìŠ¤íŠ¸ ë¡œê·¸ í™•ì¸
2. âœ… í†µí•© í…ŒìŠ¤íŠ¸ ë¡œê·¸ í™•ì¸
3. âœ… ì„±ëŠ¥ ì§€í‘œ ë¶„ì„
4. ğŸ“ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¬¸ì„œí™”
5. ğŸš€ PR ì œì¶œ

---

## ğŸ“ ë¬¸ì œ ë°œìƒ ì‹œ

í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ ë‹¤ìŒ ì •ë³´ë¥¼ ì œê³µí•´ì£¼ì„¸ìš”:

1. ì‹¤í–‰í•œ ëª…ë ¹ì–´
2. ì½˜ì†” ì „ì²´ ì¶œë ¥
3. ë¡œê·¸ íŒŒì¼ ë‚´ìš©
4. `build/reports/tests/test/index.html` ìŠ¤í¬ë¦°ìƒ·

Claudeê°€ ë¶„ì„í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤!
