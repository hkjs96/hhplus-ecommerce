# Codex 작업 가이드 (hhplus-ecommerce)

이 문서는 “내가 IDE에서 Codex에게 **일을 잘 시키는 방법**”을 정리합니다. 이 프로젝트의 규칙 단일 소스는 `./AGENTS.md` 입니다.

## 기본 운영 원칙

- **리스트업 후 1개씩:** 변경할 게 많아도 먼저 “변경 후보 리스트(우선순위/리스크/관련 테스트)”만 만들고, 실제 코드 변경은 **한 번에 1개 태스크만** 끝까지 처리합니다.
- **테스트가 요구사항:** Testcontainers(MySQL/Redis) 기반 통합 테스트를 유지합니다. Repository/DB 레이어 mock으로 우회하지 않습니다.
- **아키텍처/트랜잭션:** 4-layer 의존 규칙을 지키고, 외부 연동/사이드이펙트는 `@TransactionalEventListener(phase = AFTER_COMMIT)`로 분리합니다(근거: `docs/week8/README.md`).
- **import 규칙:** 타입은 import 후 짧은 이름으로 사용하고, 이름 충돌이 보인다면 우선 네이밍을 재고합니다. 정말 불가피할 때만 fully-qualified 이름을 씁니다.
- **주간 가이드:** 항상 최신 `docs/week*/README.md`를 확인해 현재 코치/Q&A 피드백을 반영하고, 필요 시 이전 주차 Q&A/피드백도 참고하되 최신 지침을 우선 적용합니다.
- **페르소나 검증:** 코드 변경 시 위 가이드/피드백을 준수했는지 5인 시니어(7~20년차) 관점으로 실무 적합성을 빠르게 점검합니다.

## Pair Coding 모드(추천)

IDE에서 효율적으로 페어링하려면 “결정 지점(Decision gate)”을 명시하고, Codex가 한 번에 크게 벌리지 못하게 제어하는 게 핵심입니다.

### Decision gate (여기선 반드시 물어보기)
- **태스크 선택:** 변경 후보 리스트를 만든 다음, “이번에 1개만” 고르고 시작
- **접근 방식 선택:** 옵션이 2개 이상이면 장단점/리스크 비교 후 선택 요청
- **긴 커맨드 실행:** `./gradlew clean test`, `./gradlew test jacocoTestReport`는 실행 전 OK 받기
- **범위 증가:** 파일/테스트가 늘어나기 시작하면 “쪼개서 다음 태스크로” 제안

### Codex에게 먼저 주면 좋은 정보(체크리스트)
- 재현 커맨드(가능하면 단일 테스트): `./gradlew test --tests "..."` 또는 실패 로그
- 기대 동작/실제 동작(1~2문장)
- 완료 조건(acceptance criteria): “이 테스트가 통과하고, 사이드 이펙트가 AFTER_COMMIT로 분리됨” 같은 형태
- 관련 문서/규칙: `docs/week8/README.md`, `AGENTS.md`

## Codex에게 시키는 표준 흐름(템플릿)

1. **현재 상황 요약**: 기대 동작 vs 실제 동작, 에러 로그/스택트레이스, 관련 문서 링크(저장소 내).
2. **변경 후보 리스트 요청**: “무엇을 바꿔야 할지”를 먼저 나열하되, 코드는 바꾸지 말라고 지시합니다.
3. **1개 태스크 선택**: 가장 작은 단위(하나의 failing test/feature)로 좁힙니다.
4. **테스트-퍼스트**: 실패하는 테스트를 먼저 추가/수정하고, 그 테스트만 돌려서 실패를 확인합니다.
5. **최소 수정으로 통과**: 프로덕션 코드 변경 → 해당 테스트 통과 → 전체 테스트 → 최종 `clean test` + `jacoco`.

### “긴 테스트” 실행은 먼저 물어보기
환경에 따라 `./gradlew clean test`, `./gradlew test jacocoTestReport`는 오래 걸리거나(컨테이너 풀/빌드 캐시) 승인이 필요할 수 있습니다. Codex에게는 다음처럼 지시하세요.

- “우선 `./gradlew test --tests "..."`만 실행해서 재현/통과부터 확인하고, `clean test`/`jacoco`는 **내가 OK 하면** 돌려줘.”

## “변경 후보 리스트”를 잘 뽑게 하는 문장

Codex에게 아래처럼 요구하면, 큰 변경을 한 번에 벌이는 걸 줄일 수 있습니다.

- “아래 요구사항/로그를 기준으로, 변경 후보를 5~10개로 나열하고 **각 항목에 (1) 변경 파일 후보 (2) 관련/추가해야 할 테스트 (3) 리스크**를 붙여줘. 아직 코드는 수정하지 마.”
- “그 리스트 중에서 **가장 작은 태스크 1개**만 골라서, 테스트-퍼스트로 진행하자.”

## 통합 테스트(Testcontainers) 변경 체크리스트

통합 테스트가 많아질수록 flaky가 생기기 쉬우니, 아래를 Codex에게 명시적으로 요구하세요.

- **시간 의존 제거:** `sleep`/타임아웃 기반 성공을 피하고, 상태(DB row, 이벤트 처리 결과)를 기다리는 방식으로 테스트 설계.
- **데이터 격리:** 테스트 간 공유 데이터/순서 의존을 없애고, 매 테스트가 독립적으로 실행되게 구성.
- **정리 보장:** 트랜잭션 롤백/DB 초기화 전략을 일관되게(프로젝트 기존 패턴 우선).
- **동시성 테스트는 명시적:** 멀티스레드/락 테스트는 재현 가능한 방식(Barrier/Latch)으로 구성하고, assertions는 구체적으로 유지.

## 실패 로그를 제공하는 방법(IDE에서)

- 실패한 테스트 이름과 한 줄 요약, 그리고 전체 스택트레이스를 제공합니다.
- 가능하면 **해당 테스트만 재현 가능한 커맨드**도 같이 제공합니다:
  - `./gradlew test --tests "fully.qualified.TestClassName"`

## Codex 제어 문구(크게 벌리려 할 때 멈추기)

- “지금 변경 범위가 커졌어. **파일 1~3개/200 LoC 이하**로 쪼개서, 이번 태스크에 필요한 최소 수정만 하자.”
- “리네임/패키지 이동/대규모 리팩터는 금지. **행동(테스트) 단위**로만 수정해.”
- “우선 failing test 하나를 고정하고, 그 테스트만 통과시키는 데 집중해.”

## 바로 쓰는 “태스크 지시 프롬프트” 템플릿

아래 템플릿을 그대로 붙여넣고, `[]`만 채워서 사용하세요.

```
페어 코딩 모드로 진행해줘. Decision gate(태스크 선택/옵션 선택/긴 커맨드/범위 증가)마다 내 확인을 받아.
저장소 규칙은 ./AGENTS.md 를 단일 소스로 따르세요.

목표: [버그/기능 한 줄]
기대 동작: [...]
실제 동작/에러: [...]
관련 파일(추정): [...]
관련 문서: docs/week8/README.md (트랜잭션/이벤트 원칙)

요구:
1) 먼저 “변경 후보 리스트(5~10개)”를 작성해줘: 각 항목에 (a) 변경 파일 후보 (b) 추가/수정할 테스트 (c) 리스크를 포함. 아직 코드는 수정하지 마.
2) 내가 1개를 고르면, 그 태스크에 대해 테스트-퍼스트로 진행:
   - 실패 테스트 추가/수정 → `./gradlew test --tests "..."`로 실패 확인
   - 최소 프로덕션 코드 수정으로 통과
   - `./gradlew test` 통과
   - 최종 `./gradlew clean test` + `./gradlew test jacocoTestReport`는 **내가 OK 하면** 실행
제약: 패키지 이동/대규모 리팩터/임의 스타일 변경 금지. 통합테스트는 Testcontainers 유지(Repo/DB mock 금지).
```
