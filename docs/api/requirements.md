# 요구사항 명세서

## 프로젝트 개요
항해플러스 이커머스 시스템 - 상품 주문 및 결제 시스템 (2주차 과제)

**핵심 목표**: 애플리케이션 레벨에서 가용성을 보장하는 이커머스 시스템 설계

---

## 핵심 기능 요구사항

### 1. 상품 관리 📦

#### 1.1 상품 조회
- **상품 목록 조회**
  - 카테고리별 필터링
  - 정렬 기능 (가격순, 인기순, 최신순)
  - 페이지네이션 (선택)

- **상품 상세 조회**
  - 상품명, 가격, 설명, 카테고리
  - 현재 재고 수량

#### 1.2 재고 관리
- **재고 실시간 확인**
  - Stock 테이블에서 관리
  - 재고 현황과 이력 분리
- **재고 변동 추적**
  - StockHistory로 모든 변동 기록
  - 입고, 출고, 취소, 조정 타입 관리

#### 1.3 인기 상품 통계
- **최근 3일간 Top 5**
  - 판매량 기준 정렬
  - 상품명, 판매수량, 매출액 표시
- **실시간 쿼리 방식**
  - MySQL에서 직접 집계 쿼리 실행
  - 간단한 JOIN 쿼리로 구현
  - 조회 실패 시 빈 배열 반환 (Fallback)

> **설계 결정**: 초기에는 실시간 쿼리로 단순하게 구현하고, 성능 이슈 발생 시 배치/캐시로 개선 (Week 2 피드백 반영)

---

### 2. 주문/결제 시스템 💳

#### 2.1 장바구니
- **장바구니 관리**
  - 상품 추가/수정/삭제
  - 장바구니 조회 (사용자별)
  - 재고 부족 상품 표시
- **주문 전환**
  - 장바구니에서 주문 생성
  - 주문 시 재고 재확인

#### 2.2 포인트 시스템
- **포인트 충전**
  - 사용자는 포인트를 미리 충전 (User.balance)
  - 양수 금액만 충전 가능
  - 충전 즉시 반영
- **포인트 조회**
  - 현재 보유 포인트 확인
- **결제 방식**
  - PG 없음, 충전된 포인트로만 결제
  - 잔액 부족 시 결제 실패

#### 2.3 주문 생성
- **주문 프로세스**
  - 재고 확인 (충분한 경우에만 생성)
  - 쿠폰 할인 적용 (선택)
  - 주문 금액 계산 (소계, 할인, 최종금액)
  - 여러 상품 동시 주문 가능

#### 2.4 결제 처리
- **결제 흐름**
  - 포인트 잔액 확인
  - 결제 완료 후 재고 차감 (재고 차감 시점 명확화)
  - 결제 완료 후 포인트 차감
  - 결제 실패 시 주문 상태 유지 (PENDING)
- **트랜잭션 관리**
  - 결제와 재고 차감은 하나의 트랜잭션
  - 실패 시 롤백

#### 2.5 주문 내역
- **주문 조회**
  - 사용자별 주문 목록
  - 주문 상세 정보 (상품, 금액, 쿠폰)
  - 주문 상태별 필터링 (PENDING, COMPLETED)
  - 최신순 정렬

---

### 3. 쿠폰 시스템 🎟️

#### 3.1 쿠폰 발급
- **선착순 발급**
  - 한정된 수량만 발급
  - 1인 1매 제한 (DB Unique 제약)
  - 발급 시 남은 수량 표시
- **동시성 제어**
  - Optimistic Lock으로 정확한 수량 제어
  - 수량 소진 시 발급 불가

#### 3.2 쿠폰 검증
- **유효성 체크**
  - 만료일 확인
  - 사용 여부 확인
  - 쿠폰 상태 (AVAILABLE, USED, EXPIRED)

#### 3.3 쿠폰 조회
- **보유 쿠폰 목록**
  - 사용자별 쿠폰 조회
  - 쿠폰 상태별 필터링
  - 할인율, 유효기간 표시

---

### 4. 외부 데이터 플랫폼 연동 🔗

#### 4.1 주문 데이터 전송
- **비동기 전송**
  - 주문 완료 후 외부 플랫폼으로 전송
  - 주문 프로세스는 블로킹하지 않음
- **데이터 변환**
  - 내부 형식 → 외부 형식 변환

#### 4.2 실패 처리
- **재시도 메커니즘**
  - 전송 실패 시 재시도 큐에 저장
  - 백그라운드에서 재시도 (1분, 5분, 30분 간격)
  - 최대 3회 재시도
- **주문 정상 처리**
  - 외부 전송 실패가 주문 완료를 막지 않음
  - 주문은 항상 정상 완료 (Fallback)

---

## 📊 애플리케이션 레벨 가용성

### 가용성 보장의 의미
> 외부/내부 일부 컴포넌트가 느리거나 실패해도, **핵심 유스케이스가 중단되지 않도록** 애플리케이션 레벨에서 설계·구현·운영

---

### 필수 가용성 패턴

#### 1. Timeout & Retry 🔄
- **모든 외부 호출에 Timeout 설정** (3초)
- 실패 시 재시도 (최대 3회, Exponential Backoff)
- 재시도 불가능한 에러는 즉시 실패 처리

**적용 대상:**
- 외부 데이터 플랫폼 API 호출

#### 2. Fallback (대체 로직) 🛡️
- **주 기능 실패 시 대체 동작**

**예시:**
- 데이터 플랫폼 전송 실패 → 큐에 저장 후 나중에 재시도
- 인기 상품 조회 실패 → 빈 배열 반환

#### 3. Async Processing (비동기 처리) ⚡
- **비핵심 작업은 비동기로**

**적용 대상:**
- 외부 데이터 플랫폼 전송 ✅

---

## 비기능적 요구사항

### 동시성 제어

#### 재고 차감
- **전략**: Optimistic Lock (Stock 테이블)
- **목표**: 동시 구매 시 재고 정확성 보장 (음수 불가)
- **실패 시**: 재시도 로직

#### 쿠폰 발급
- **전략**: Optimistic Lock (Coupon 테이블)
- **목표**: 정확한 수량 제어 (선착순)
- **실패 시**: 명확한 에러 응답

#### 포인트 차감
- **전략**: Pessimistic Lock (User 테이블)
- **목표**: 잔액 정확성 최우선
- **이유**: 충돌 빈도 낮음, 정확성 중요

---

### 데이터 일관성

#### 트랜잭션 관리
- **결제 실패 시 재고 복원** (트랜잭션 롤백)
- **재고 차감 시점**: 결제 완료 후
- **포인트 차감**: 결제 완료 시 동시 처리
- `@Transactional` 적절히 사용

#### 재고 이력 관리
- 모든 재고 변동은 StockHistory에 기록
- INSERT ONLY 테이블 (수정/삭제 불가)
- 외래키 제약조건 없음 (조회 목적, 성능 최적화)

---

### 외부 연동 원칙

- **외부 전송 실패가 주문 완료를 막지 않음** ✅
- **Timeout**: 모든 외부 호출은 3초 이내
- **Retry**: 최대 3회, Exponential Backoff
- **Async**: 비동기 처리로 주문 프로세스 블로킹 방지

---

### 성능 요구사항

- **API 응답 시간**: 평균 200ms 이하
- **동시 접속**: 100명 이상 처리 가능
- **인기 상품 조회**: 실시간 쿼리 (인덱스 활용)

---

## 주요 제약사항

### 재고 관리
- **정확성**: 실시간 재고 반영 (Stock 테이블)
- **동시성**: 동시 구매 시 재고 보장 (음수 불가)
- **복구**: 결제 실패 시 재고 복원
- **이력**: 모든 재고 변동 StockHistory에 기록

### 쿠폰 시스템
- **선착순**: 정확한 수량 제어 (Optimistic Lock)
- **중복 방지**: 1인 1매 제한 (DB Unique 제약)
- **유효성**: 만료/사용 여부 체크

### 주문 프로세스
- **재고 차감 시점**: 결제 완료 후 (명확히 정의)
- **결제와 재고 차감**: 하나의 트랜잭션
- **외부 시스템 연동**: 비동기, 실패해도 주문은 완료

### 장바구니
- **유효성**: 주문 전환 시 재고 재확인
- **저장 방식**: DB 또는 In-Memory (선택)

### 포인트 시스템
- **충전 방식**: 사용자가 미리 포인트 충전
- **결제 방식**: 충전된 포인트로만 결제 가능
- **PG 없음**: 외부 결제 연동 없이 내부 포인트만 사용

---

## 기능 우선순위

### Phase 1: 핵심 기능
1. ✅ 상품 조회 (목록, 상세, 재고)
2. ✅ 장바구니 (추가, 조회, 수정, 삭제)
3. ✅ 포인트 관리 (충전, 조회)
4. ✅ 주문 생성 (재고 확인, 쿠폰 적용)
5. ✅ 결제 처리 (포인트 기반)
6. ✅ 쿠폰 발급/사용 (선착순)

### Phase 2: 가용성 강화
1. ✅ Timeout & Retry 설정
2. ✅ Fallback 구현
3. ✅ 비동기 처리 (외부 전송)
4. ✅ 외부 데이터 전송 (비동기, Fallback)

### Phase 3: 선택 기능
1. 성능 최적화 및 모니터링
2. 추가 인덱스 최적화

---

## 제외 사항 (범위 밖)

### 기능
- ❌ 배송 관리 및 배송 추적
- ❌ 외부 PG 연동 (토스페이 등)
- ❌ 실시간 알림 (푸시, SMS)
- ❌ 리뷰/평점 시스템
- ❌ 위시리스트
- ❌ 복잡한 검색 (Elasticsearch)
- ❌ 추천 시스템 (ML 기반)

### 인프라
- ❌ 분산 환경 (다음 과제)
- ❌ Redis 실제 구현 (설계만)
- ❌ Kafka 실제 구현 (설계만)

---

## 기술 스택

### Week 2 (설계 단계) 범위

#### 데이터 저장
- **주 데이터베이스**: H2 (In-Memory) 또는 MySQL
- **캐시**: In-Memory 캐시 (인기 상품)
- **재시도 큐**: In-Memory Queue

#### Mock 서버 구현
- **Spring Boot Mock Server** (db.json X)
- **In-Memory Collection** 사용
- **RestTemplate/WebClient** Mock

#### 라이브러리
- **Spring Async**: 비동기 처리

> ⚠️ **중요**: Week 2는 **설계 단계**입니다. 완전한 시스템 설계를 목표로 하며, Mock 서버는 In-Memory로 구현합니다.

---

## 성공 기준

### 기능적 성공
- [ ] 동시 주문 시 재고 정확성 보장
- [ ] 선착순 쿠폰 정확한 수량 제어
- [ ] 외부 API 실패 시에도 주문 완료
- [ ] 장바구니에서 주문까지 완전한 플로우
- [ ] 포인트 충전 및 결제 정상 동작

### 비기능적 성공
- [ ] 외부 API 타임아웃 시 3초 이내 Fallback
- [ ] 인기 상품 조회 실패 시 빈 배열 반환
- [ ] 동시 100명 주문 처리 성공
- [ ] 재고 변동 이력 완전 추적

---

## 참고: 외부 시스템 연동 시나리오

### 시나리오 1: 정상 흐름
```
주문 완료 → 데이터 플랫폼 전송 (비동기) → 성공 로그
```

### 시나리오 2: 외부 API 장애
```
주문 완료 → 데이터 플랫폼 전송 시도 → Timeout (3초)
→ Retry (3회, Exponential Backoff) → 모두 실패
→ Fallback (재시도 큐에 저장)
→ 주문은 정상 완료 ✅
→ 백그라운드 재시도 (1분 후, 5분 후, 30분 후)
```

### 시나리오 3: 인기 상품 조회 실패
```
인기 상품 조회 요청 → MySQL 쿼리 실행
→ 쿼리 실패 (DB 장애 등)
→ Fallback (빈 배열 반환)
→ 사용자는 오류 없이 빈 목록 조회 ✅
```

---

## 📌 핵심 요약

### 이커머스 핵심 기능 (4가지)

| 구분 | 내용 |
|------|------|
| **1. 상품 관리** | 상품 조회, 재고 확인, 인기 상품 Top 5 |
| **2. 주문/결제** | 장바구니, 포인트 충전/결제, 쿠폰 적용, 주문 내역 |
| **3. 쿠폰 시스템** | 선착순 발급, 유효성 검증, 1인 1매 제한 |
| **4. 외부 연동** | 비동기 전송, 실패 시 재시도, 주문은 정상 처리 |

### 가용성 패턴 (필수 3가지)

| 패턴 | 적용 |
|------|------|
| **Timeout & Retry** | 외부 API 호출 시 3초 Timeout, 3회 재시도 |
| **Fallback** | 외부 실패 시 큐 저장, 배치 실패 시 캐시 반환 |
| **Async** | 외부 전송, 통계 집계 비동기 처리 |

### 동시성 제어

| 대상 | 전략 | 이유 |
|------|------|------|
| **재고** | Optimistic Lock | 높은 동시성, 재시도 가능 |
| **쿠폰** | Optimistic Lock | 선착순, 충돌 시 명확한 에러 |
| **포인트** | Pessimistic Lock | 정확성 최우선 |

---

## 설계 원칙

1. **단순함**: 핵심 기능에 집중, 불필요한 확장 배제
2. **가용성**: 외부 장애가 핵심 기능을 막지 않음
3. **정확성**: 재고/쿠폰/포인트 동시성 제어로 정확성 보장
4. **추적성**: 모든 재고 변동 이력 기록
5. **확장성**: 향후 다중 창고, PG 연동 등 확장 가능한 구조
