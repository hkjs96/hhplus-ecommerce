# Week 10 - Runbook (장애 대응 체크리스트, 학습용)

이 런북은 로컬 `docker compose` 환경과 “운영 환경 가정” 모두에서 쓸 수 있도록, **진단 순서**와 **즉시 완화 옵션**을 중심으로 작성했습니다.

## 0) 공통: 장애 대응 시작 5분 루틴
1. **영향도 선언:** 어떤 사용자/기능이 영향을 받는가? (주문/결제/조회/쿠폰 등)
2. **현재 상태 확인:** error rate, p95/p99, 트래픽, 주요 의존성(DB/Redis/Kafka) 상태
3. **최근 변경 확인:** 최근 배포/설정 변경/배치/스키마 변경 여부
4. **완화 우선:** 원인 규명보다 사용자 영향 최소화가 먼저(롤백/차단/토글/제한)
5. **기록:** 타임라인(언제 무엇을 봤고, 무엇을 했는지)

## 1) 로컬 관측/확인 포인트 (Week10 기준)
### 1.1 대시보드/타겟
- Prometheus: `http://localhost:9090/targets`
- Grafana: `http://localhost:3000` (admin/admin)

### 1.2 컨테이너 상태
- 상태: `docker compose ps`
- 로그(짧게): `docker compose logs --tail=200 app`
- 자원 사용: `docker stats`

## 2) 증상별 Runbook

## 2.1 “요청 실패(5xx) 급증”
### 진단
- 앱 로그에서 예외 유형 확인: `docker compose logs --tail=300 app`
- DB 연결 문제 징후
  - MySQL 컨테이너 재시작/헬스 불량, 커넥션 풀 고갈, 타임아웃
- Redis/Kafka 의존성 문제 징후
  - 커넥션 실패, 타임아웃, 브로커 연결 실패

### 즉시 완화
- **롤백**(운영 가정): 직전 버전으로 되돌리기
- **기능 토글/차단**(가능한 경우): 쓰기 API를 일시 제한(주문 생성 등)
- **스케일 아웃**(운영 가정): 앱 인스턴스 수 증가

### 확인
- 5xx 비율이 정상으로 복귀하는지(몇 분 동안 유지)
- 재발 여부(메트릭/로그)

## 2.2 “지연시간(p95/p99) 급증, 에러는 적음”
### 진단 우선순위(가장 흔한 순)
1. **DB 병목**: 슬로우 쿼리/락/커넥션 풀 포화
2. **GC/메모리 압박**: GC pause 증가, heap 압박
3. **외부 의존성 지연**: Redis/Kafka 네트워크/응답 지연

### 로컬에서 빠른 확인
- 앱 로그에 “slow request / timeout” 여부
- `docker stats`로 CPU/메모리 급증 확인

### 즉시 완화
- **부하 제한**: loadtest 중단 또는 RPS 낮추기
- **스케일 업/아웃**(운영 가정): CPU/메모리 증설 또는 인스턴스 증가
- **DB 보호**: 쓰기 경로 제한(주문 생성 등), 캐시 활용 확대(가능한 경우)

## 2.3 “MySQL 문제(연결 불가/타임아웃/재시작 반복)”
### 진단
- 컨테이너 로그: `docker compose logs --tail=300 mysql`
- 디스크/메모리 부족 여부(`docker stats`)
- (운영 가정) MySQL 커넥션/락/슬로우 쿼리 지표 확인

### 즉시 완화
- 앱에서 DB 접근이 많은 엔드포인트를 제한/차단
- (운영 가정) 읽기/쓰기 분리, 커넥션 풀 상한/타임아웃 조정(단, 근본 해결 전 임시)

### 예방 포인트
- MySQL binlog/디스크 관리(week10 compose에 binlog 만료 설정 권장)
- 인덱스/쿼리 튜닝(핵심 경로부터)

## 2.4 “Redis 문제(캐시 미스 급증/커넥션 실패)”
### 진단
- 컨테이너 로그: `docker compose logs --tail=200 redis`
- 메모리 상한 도달 여부(현재 compose는 `--maxmemory 256mb`)

### 즉시 완화
- 캐시 의존도가 높은 경로의 요청량 제한(운영 가정: rate limit)
- 캐시 무효화 폭주 방지(운영 가정: TTL/락/요청 coalescing)

## 2.5 “Kafka 문제(브로커 다운/지연/메시지 적체)”
### 진단(운영 가정)
- **consumer lag** 증가, 재시도 폭증, DLQ 적재 여부
- 브로커 리소스(CPU/디스크) 확인

### 즉시 완화
- (운영 가정) producer side backpressure / 비동기 처리량 제한
- (운영 가정) consumer scale-out 또는 batch 크기 조정

### 예방 포인트
- 보관 정책(retention)으로 디스크 폭증 방지
- 파티션/세그먼트/압축/배치 튜닝은 “증상”과 “목표”가 있어야 함

## 2.6 “디스크가 갑자기 꽉 참 (Docker.raw 폭증 포함)”
### 진단(로컬)
- 컨테이너 로그 폭증: `docker compose logs --tail=50 <service>`
- Docker 사용량: `docker system df -v`

### 즉시 완화(로컬)
- 불필요 컨테이너 중단: `docker compose down`
- (주의) 볼륨까지 삭제: `docker compose down -v`  ← DB 데이터도 삭제됨

### 예방 포인트
- 컨테이너 로그 로테이션(`max-size`, `max-file`)
- Prometheus/Kafka/DB의 “데이터 보관 상한” 설정

## 3) 커뮤니케이션 템플릿(운영 가정)
- **현상:** 5xx 3% → 25%, p95 200ms → 3s
- **영향:** 주문 생성/결제 실패, 14:02~진행 중
- **조치:** 14:05 롤백 시작, 14:08 트래픽 정상화
- **다음:** 재발 방지(알림/런북/쿼리 최적화) 액션 아이템 예정

