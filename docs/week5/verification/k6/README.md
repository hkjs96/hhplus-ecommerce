# K6 ë¶€í•˜ í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ

## ğŸ“Š ìµœì‹  í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¶„ì„ (2025-11-24)

### Test 1: ë‹¤ì¤‘ ì‚¬ìš©ì ë¶€í•˜ í…ŒìŠ¤íŠ¸ âœ… **PASSED**

**ì‹œë‚˜ë¦¬ì˜¤**: 100ëª…ì˜ ì‚¬ìš©ìì—ê²Œ ë¶„ì‚° ìš”ì²­ (USER_ID 1~100)

**ì‹¤í–‰ ì‹œê°„**: 5ë¶„ 5ì´ˆ

**ê²°ê³¼ ìš”ì•½**:
```
ì´ ìš”ì²­: 156,988
ì„±ê³µë¥ : 99.99% (156,984 ì„±ê³µ / 4 ì‹¤íŒ¨)
Optimistic Lock ì¶©ëŒ: 4ê±´
í‰ê·  ì‘ë‹µ ì‹œê°„: 823ms
ì¤‘ì•™ê°’: 475ms
P90: 2.37s
P95: 2.93s (ëª©í‘œ: 1s ë¯¸ë§Œ) âŒ
P99: 4.2s (ëª©í‘œ: 2s ë¯¸ë§Œ) âŒ
ìµœëŒ€: 33.25s
TPS: 514.6 req/s
```

**Threshold ê²°ê³¼**:
- âœ… `errors rate < 0.05`: 0.00% (Passed)
- âœ… `success rate > 0.95`: 99.99% (Passed)
- âœ… `optimistic_lock_conflicts < 1000`: 4 (Passed)
- âŒ `http_req_duration p(95) < 1000ms`: 2.93s (Failed)
- âŒ `http_req_duration p(99) < 2000ms`: 4.2s (Failed)

**ë¶„ì„**:
- âœ… **ì•ˆì •ì„± íƒì›”**: 99.99% ì„±ê³µë¥ , ê±°ì˜ 0%ì— ê°€ê¹Œìš´ ì—ëŸ¬ìœ¨
- âœ… **ë™ì‹œì„± ì œì–´ ìš°ìˆ˜**: 156,988 ìš”ì²­ ì¤‘ ë‹¨ 4ê±´ì˜ Optimistic Lock ì¶©ëŒ (0.0025%)
- âœ… **ë†’ì€ ì²˜ë¦¬ëŸ‰**: 514.6 req/s ì§€ì† ìœ ì§€
- âš ï¸ **ë ˆì´í„´ì‹œ ê°œì„  í•„ìš”**: P95(2.93s), P99(4.2s)ê°€ ëª©í‘œë¥¼ ì´ˆê³¼
- âš ï¸ **ì¼ë¶€ ê·¹ë‹¨ê°’**: ìµœëŒ€ 33ì´ˆê¹Œì§€ ê±¸ë¦° ìš”ì²­ì´ ì¡´ì¬

**ê²°ë¡ **: ì‹œìŠ¤í…œì´ 1000ëª…ì˜ ë™ì‹œ ì‚¬ìš©ìë¥¼ ì•ˆì •ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ì§€ë§Œ, ê³ ë¶€í•˜ ì‹œ ì‘ë‹µ ì‹œê°„ì´ ì¦ê°€

---

### Test 2: ë‹¨ì¼ ì‚¬ìš©ì ë™ì‹œì„± í…ŒìŠ¤íŠ¸ âš ï¸ **PARTIAL PASS**

**ì‹œë‚˜ë¦¬ì˜¤**: ë‹¨ì¼ ì‚¬ìš©ì(USER_ID=1)ì—ê²Œ ì§‘ì¤‘ ê³µê²©

**ì‹¤í–‰ ì‹œê°„**: 5ë¶„ 22ì´ˆ

**ê²°ê³¼ ìš”ì•½**:
```
ì´ ìš”ì²­: 31,843
ì„±ê³µë¥ : 97.66% (31,100 ì„±ê³µ / 743 ì‹¤íŒ¨)
Optimistic Lock ì¶©ëŒ: 743ê±´
í‰ê·  ì‘ë‹µ ì‹œê°„: 3.65s
ì¤‘ì•™ê°’: 1.66s
P90: 6.03s
P95: 11.69s (ëª©í‘œ: 1s ë¯¸ë§Œ) âŒ
P99: 30.92s (ëª©í‘œ: 2s ë¯¸ë§Œ) âŒ
ìµœëŒ€: 31.73s
TPS: 98.9 req/s
```

**Threshold ê²°ê³¼**:
- âœ… `errors rate < 0.05`: 2.33% (Passed)
- âœ… `success rate > 0.95`: 97.66% (Passed)
- âœ… `optimistic_lock_conflicts < 1000`: 743 (Passed)
- âŒ `http_req_duration p(95) < 1000ms`: 11.69s (Failed)
- âŒ `http_req_duration p(99) < 2000ms`: 30.92s (Failed)

**ë¶„ì„**:
- âœ… **ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜ ì‘ë™**: 97.66% ì„±ê³µë¥  ìœ ì§€ (ê·¹í•œ ìƒí™©ì—ì„œë„ ì•ˆì •ì )
- âœ… **Optimistic Lock ì œì–´**: 743ê±´ì˜ ì¶©ëŒ ë°œìƒí–ˆì§€ë§Œ ëŒ€ë¶€ë¶„ ì¬ì‹œë„ ì„±ê³µ
- âš ï¸ **Lock Contention ì‹¬ê°**: ë‹¨ì¼ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ê²½ìŸìœ¼ë¡œ ì‘ë‹µ ì‹œê°„ ê¸‰ì¦
- âš ï¸ **ì²˜ë¦¬ëŸ‰ ê°ì†Œ**: 98.9 req/s (ë‹¤ì¤‘ ì‚¬ìš©ì ëŒ€ë¹„ 5ë°° ê°ì†Œ)
- âš ï¸ **ë†’ì€ ë ˆì´í„´ì‹œ**: P95 11.69s, P99 30.92s (ì¬ì‹œë„ + ëŒ€ê¸° ì‹œê°„)

**ê²°ë¡ **: ê·¹í•œ ë™ì‹œì„± ìƒí™©ì—ì„œë„ ì‹œìŠ¤í…œì´ ì‹¤íŒ¨í•˜ì§€ ì•Šê³  ì¬ì‹œë„ë¥¼ í†µí•´ ë³µêµ¬

---

## ğŸ¯ ê°œì„ ëœ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### 1. `balance-charge.js` - ë‹¤ì¤‘ ì‚¬ìš©ì ë¶€í•˜ í…ŒìŠ¤íŠ¸ â­ ê¶Œì¥

**ëª©ì **: ì‹¤ì œ í”„ë¡œë•ì…˜ í™˜ê²½ ì‹œë®¬ë ˆì´ì…˜

**ì‹œë‚˜ë¦¬ì˜¤**:
- 1000 VUê°€ **100ëª…ì˜ ì‚¬ìš©ì(USER_ID 1~100)**ì—ê²Œ ë¶„ì‚° ìš”ì²­
- ë‹¨ê³„ì  ë¶€í•˜: 100 â†’ 500 â†’ 1000 VUs
- Optimistic Lock ì¶©ëŒ ìµœì†Œí™”

**ê¸°ëŒ€ ê²°ê³¼**:
```
ì„±ê³µë¥ : >99%
Optimistic Lock ì¶©ëŒ: <100ê±´
í‰ê·  ì‘ë‹µ ì‹œê°„: <100ms
P95: <500ms
P99: <1s
TPS: ~300-500 req/s
```

**ì‹¤í–‰ ë°©ë²•**:
```bash
k6 run docs/week5/verification/k6/scripts/balance-charge.js
```

---

### 2. `balance-charge-single-user.js` - ë‹¨ì¼ ì‚¬ìš©ì ë™ì‹œì„± í…ŒìŠ¤íŠ¸

**ëª©ì **: Optimistic Lock ë° ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜ ê²€ì¦

**ì‹œë‚˜ë¦¬ì˜¤**:
- 1000 VUê°€ **ë‹¨ì¼ ì‚¬ìš©ì(USER_ID=1)**ì—ê²Œ ì§‘ì¤‘ ê³µê²©
- Optimistic Lock ì¶©ëŒ ì˜ë„ì  ë°œìƒ
- ì¬ì‹œë„ ë¡œì§ ì‘ë™ í™•ì¸

**ê¸°ëŒ€ ê²°ê³¼**:
```
ì„±ê³µë¥ : >95%
Optimistic Lock ì¶©ëŒ: 500-1000ê±´
í‰ê·  ì‘ë‹µ ì‹œê°„: 1-5s
ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜: ì‘ë™
```

**ì‹¤í–‰ ë°©ë²•**:
```bash
k6 run docs/week5/verification/k6/scripts/balance-charge-single-user.js
```

---

## ğŸ“ˆ ì‹¤ì¸¡ ë¹„êµ ë¶„ì„

| í•­ëª© | balance-charge.js (ë‹¤ì¤‘ ì‚¬ìš©ì) | balance-charge-single-user.js (ë‹¨ì¼ ì‚¬ìš©ì) |
|------|--------------------------------|------------------------------------------|
| **ëª©ì ** | ì‹¤ì œ ë¶€í•˜ í…ŒìŠ¤íŠ¸ | ë™ì‹œì„± ì œì–´ ê²€ì¦ |
| **ì‚¬ìš©ì** | ë‹¤ì¤‘ (1~100) | ë‹¨ì¼ (USER_ID=1) |
| **ì´ ìš”ì²­** | 156,988 | 31,843 |
| **ì„±ê³µë¥ ** | 99.99% âœ… | 97.66% âš ï¸ |
| **ì¶©ëŒ** | 4ê±´ (ìµœì†Œ) | 743ê±´ (ì˜ë„ì ) |
| **í‰ê·  ì‘ë‹µ ì‹œê°„** | 823ms | 3.65s |
| **ì¤‘ì•™ê°’** | 475ms | 1.66s |
| **P95** | 2.93s | 11.69s |
| **P99** | 4.2s | 30.92s |
| **TPS** | 514.6 req/s âœ… | 98.9 req/s |
| **Lock Contention** | ê±°ì˜ ì—†ìŒ | ì‹¬ê° |
| **ê¶Œì¥ ìš©ë„** | ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí‚¹ | ë²„ê·¸ ê²€ì¦ |

**í•µì‹¬ ì¸ì‚¬ì´íŠ¸**:
1. **ë‹¤ì¤‘ ì‚¬ìš©ì í™˜ê²½ (ì‹¤ì œ í™˜ê²½)**: ë™ì‹œì„± ì œì–´ê°€ ì˜ ì‘ë™í•˜ì—¬ ì¶©ëŒì´ ê±°ì˜ ì—†ìŒ
2. **ë‹¨ì¼ ì‚¬ìš©ì í™˜ê²½ (ê·¹í•œ ìƒí™©)**: ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜ì´ ì‘ë™í•˜ì—¬ 97.66% ì„±ê³µë¥  ìœ ì§€
3. **TPS ì°¨ì´ 5ë°°**: ë‹¤ì¤‘ ì‚¬ìš©ì(514.6) vs ë‹¨ì¼ ì‚¬ìš©ì(98.9)
4. **ì‘ë‹µ ì‹œê°„ ì°¨ì´**: ë‹¤ì¤‘ ì‚¬ìš©ìê°€ í‰ê·  4.4ë°° ë¹ ë¦„ (823ms vs 3.65s)

---

## ğŸ”§ í…ŒìŠ¤íŠ¸ ê°œì„  ì‚¬í•­

### ë³€ê²½ ì „ (ë¬¸ì œ):
```javascript
const USER_ID = __ENV.USER_ID || '1';  // âŒ ê³ ì •
const url = `${BASE_URL}/api/users/${USER_ID}/balance/charge`;
```

### ë³€ê²½ í›„ (balance-charge.js):
```javascript
const MIN_USER_ID = parseInt(__ENV.MIN_USER_ID || '1');
const MAX_USER_ID = parseInt(__ENV.MAX_USER_ID || '100');

function getRandomUserId() {
  return Math.floor(Math.random() * (MAX_USER_ID - MIN_USER_ID + 1)) + MIN_USER_ID;
}

export default function() {
  const userId = getRandomUserId();  // âœ… ëœë¤
  const url = `${BASE_URL}/api/users/${userId}/balance/charge`;
}
```

---

## ğŸ“‹ ì‹¤í–‰ ê°€ì´ë“œ

### 1. ë‹¤ì¤‘ ì‚¬ìš©ì í…ŒìŠ¤íŠ¸ (ê¶Œì¥)
```bash
# ê¸°ë³¸ ì„¤ì • (USER_ID 1~100)
k6 run docs/week5/verification/k6/scripts/balance-charge.js

# ì‚¬ìš©ì ë²”ìœ„ ë³€ê²½
k6 run -e MIN_USER_ID=1 -e MAX_USER_ID=200 \
  docs/week5/verification/k6/scripts/balance-charge.js

# ë¦¬í¬íŠ¸ ìƒì„±
k6 run --out json=results/balance-charge-multi.json \
  docs/week5/verification/k6/scripts/balance-charge.js
```

### 2. ë‹¨ì¼ ì‚¬ìš©ì í…ŒìŠ¤íŠ¸ (ë™ì‹œì„± ê²€ì¦)
```bash
# ê¸°ë³¸ ì„¤ì • (USER_ID=1)
k6 run docs/week5/verification/k6/scripts/balance-charge-single-user.js

# ë‹¤ë¥¸ ì‚¬ìš©ì ì§€ì •
k6 run -e USER_ID=5 \
  docs/week5/verification/k6/scripts/balance-charge-single-user.js
```

---

## ğŸ¯ ê¸°ëŒ€ ê²°ê³¼ vs ì‹¤ì œ ê²°ê³¼

### ë‹¤ì¤‘ ì‚¬ìš©ì í…ŒìŠ¤íŠ¸ (balance-charge.js)

| ë©”íŠ¸ë¦­ | ê¸°ëŒ€ê°’ | ì‹¤ì œê°’ | ê²°ê³¼ |
|--------|--------|--------|------|
| errors rate | < 1% | 0.00% | âœ… **ì´ˆê³¼ ë‹¬ì„±** |
| success rate | > 99% | 99.99% | âœ… **ëª©í‘œ ë‹¬ì„±** |
| optimistic_lock_conflicts | < 100 | 4 | âœ… **ì´ˆê³¼ ë‹¬ì„±** |
| http_req_duration p(95) | < 500ms | 2.93s | âŒ **ëª©í‘œ ë¯¸ë‹¬** |
| http_req_duration p(99) | < 1s | 4.2s | âŒ **ëª©í‘œ ë¯¸ë‹¬** |
| TPS | > 300/s | 514.6/s | âœ… **ì´ˆê³¼ ë‹¬ì„±** |

**ì¢…í•© í‰ê°€**: ì•ˆì •ì„±ê³¼ ì²˜ë¦¬ëŸ‰ì€ íƒì›”í•˜ë‚˜, ê³ ë¶€í•˜ ì‹œ ë ˆì´í„´ì‹œ ê°œì„  í•„ìš”

---

### ë‹¨ì¼ ì‚¬ìš©ì í…ŒìŠ¤íŠ¸ (balance-charge-single-user.js)

| ë©”íŠ¸ë¦­ | ê¸°ëŒ€ê°’ | ì‹¤ì œê°’ | ê²°ê³¼ |
|--------|--------|--------|------|
| errors rate | < 5% | 2.33% | âœ… **ëª©í‘œ ë‹¬ì„±** |
| success rate | > 95% | 97.66% | âœ… **ëª©í‘œ ë‹¬ì„±** |
| optimistic_lock_conflicts | 500-1000 | 743 | âœ… **ì˜ˆìƒ ë²”ìœ„** |
| http_req_duration p(95) | 1-5s | 11.69s | âš ï¸ **ì˜ˆìƒ ì´ˆê³¼** |
| http_req_duration p(99) | < 2s | 30.92s | âŒ **ëª©í‘œ ë¯¸ë‹¬** |

**ì¢…í•© í‰ê°€**: ê·¹í•œ ìƒí™©ì—ì„œë„ ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜ì´ ì‘ë™í•˜ë‚˜, ì‘ë‹µ ì‹œê°„ì´ ì˜ˆìƒë³´ë‹¤ ë†’ìŒ

---

## ğŸ’¡ ìµœì¢… ê²°ë¡  ë° ê¶Œì¥ ì‚¬í•­

### 1. ì‹œìŠ¤í…œ ì•ˆì •ì„± âœ…
- **ë‹¤ì¤‘ ì‚¬ìš©ì í™˜ê²½**: 99.99% ì„±ê³µë¥ ë¡œ ë§¤ìš° ì•ˆì •ì 
- **ë‹¨ì¼ ì‚¬ìš©ì í™˜ê²½**: 97.66% ì„±ê³µë¥ ë¡œ ê·¹í•œ ìƒí™©ì—ì„œë„ ë³µêµ¬ ê°€ëŠ¥
- **Optimistic Lock**: ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜ì´ íš¨ê³¼ì ìœ¼ë¡œ ì‘ë™

### 2. ì„±ëŠ¥ íŠ¹ì„± âš ï¸
- **ì²˜ë¦¬ëŸ‰**: 514.6 req/së¡œ ë†’ì€ TPS ë‹¬ì„± âœ…
- **ë ˆì´í„´ì‹œ**: P50(475ms)ì€ ì–‘í˜¸í•˜ë‚˜, P95(2.93s), P99(4.2s)ëŠ” ê°œì„  í•„ìš” âš ï¸
- **ë³‘ëª© ì§€ì **: ê³ ë¶€í•˜ ì‹œ ì¼ë¶€ ìš”ì²­ì˜ ì‘ë‹µ ì‹œê°„ ê¸‰ì¦ (ìµœëŒ€ 33ì´ˆ)

### 3. ê°œì„  ë°©í–¥ ì œì•ˆ

**ë‹¨ê¸° ê°œì„ **:
1. Database Connection Pool í¬ê¸° ì¡°ì • (HikariCP ì„¤ì •)
2. ì¿¼ë¦¬ ìµœì í™” (N+1 ë¬¸ì œ ì¬ê²€ì¦, ì¸ë±ìŠ¤ í™•ì¸)
3. JVM í™ ë©”ëª¨ë¦¬ ë° GC íŠœë‹
4. ëŠë¦° ì¿¼ë¦¬ ë¡œê¹… í™œì„±í™” (slow query log)

**ì¤‘ì¥ê¸° ê°œì„ **:
1. ì½ê¸° ì „ìš© ë³µì œë³¸(Read Replica) ë„ì…
2. Redis ìºì‹± ì ìš© (ì”ì•¡ ì¡°íšŒ)
3. ì»¤ë„¥ì…˜ í’€ ëª¨ë‹ˆí„°ë§ ë° ë™ì  ì¡°ì •
4. APM ë„êµ¬ ë„ì… (Pinpoint, Datadog ë“±)

### 4. í…ŒìŠ¤íŠ¸ ê²°ë¡ 

**ë‹¤ì¤‘ ì‚¬ìš©ì í…ŒìŠ¤íŠ¸ (`balance-charge.js`)**:
- âœ… í”„ë¡œë•ì…˜ í™˜ê²½ì— ì í•©
- âœ… ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí‚¹ìš©ìœ¼ë¡œ ì‚¬ìš©
- âš ï¸ P95/P99 ë ˆì´í„´ì‹œ ê°œì„  í•„ìš”

**ë‹¨ì¼ ì‚¬ìš©ì í…ŒìŠ¤íŠ¸ (`balance-charge-single-user.js`)**:
- âœ… ë™ì‹œì„± ì œì–´ ê²€ì¦ ì™„ë£Œ
- âœ… ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜ ì‘ë™ í™•ì¸
- âš ï¸ Lock Contention ìƒí™©ì—ì„œ ì‘ë‹µ ì‹œê°„ ê¸‰ì¦

**ìµœì¢… ê¶Œì¥ ì‚¬í•­**:
- ì¼ìƒì ì¸ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ëŠ” `balance-charge.js` (ë‹¤ì¤‘ ì‚¬ìš©ì) ì‚¬ìš© â­
- ë™ì‹œì„± ì œì–´ ê²€ì¦ì€ `balance-charge-single-user.js` ì‚¬ìš©
- P95/P99 ë ˆì´í„´ì‹œ ê°œì„ ì„ ìœ„í•œ ì„±ëŠ¥ íŠœë‹ í•„ìš”
