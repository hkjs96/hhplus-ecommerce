# K6 부하 테스트 결과 요약

**테스트 일자**: 2025-11-24
**테스트 대상**: 잔액 충전 API
**테스트 도구**: K6 Load Testing Tool

---

## 📊 Quick Summary

| 항목 | 다중 사용자 | 단일 사용자 |
|------|-------------|-------------|
| **시나리오** | 100명 분산 | 1명 집중 |
| **총 요청** | 156,988 | 31,843 |
| **성공률** | 99.99% ✅ | 97.66% ⚠️ |
| **TPS** | 514.6 req/s | 98.9 req/s |
| **평균 응답 시간** | 823ms | 3.65s |
| **P95** | 2.93s | 11.69s |
| **P99** | 4.2s | 30.92s |
| **Lock 충돌** | 4건 | 743건 |

---

## ✅ Test 1: 다중 사용자 (실제 환경)

### 결과
- **성공률**: 99.99% (156,984 / 156,988)
- **TPS**: 514.6 req/s
- **평균 응답 시간**: 823ms (중앙값 475ms)
- **P95**: 2.93s (목표 1s ❌)
- **P99**: 4.2s (목표 2s ❌)

### 평가
✅ **안정성**: 프로덕션 레벨
✅ **처리량**: 목표 초과 달성 (171%)
✅ **동시성 제어**: 거의 완벽 (충돌 0.0025%)
⚠️ **레이턴시**: P95/P99 개선 필요

---

## ⚠️ Test 2: 단일 사용자 (극한 상황)

### 결과
- **성공률**: 97.66% (31,100 / 31,843)
- **TPS**: 98.9 req/s (5.2배 감소)
- **평균 응답 시간**: 3.65s (중앙값 1.66s)
- **P95**: 11.69s (목표 1s ❌)
- **P99**: 30.92s (목표 2s ❌)

### 평가
✅ **재시도 메커니즘**: 극한 상황에서도 97% 성공
✅ **시스템 안정성**: 실패하지 않고 복구
⚠️ **Lock Contention**: 단일 리소스 경쟁 심각
⚠️ **응답 시간**: 재시도로 인한 지연 누적

---

## 📈 핵심 인사이트

### 1. 부하 분산의 중요성
- 다중 사용자 환경에서 TPS 5.2배 증가
- Lock Contention 최소화로 응답 시간 4.4배 단축

### 2. Optimistic Lock의 특성
- **다중 사용자**: 충돌 거의 없음 (0.0025%)
- **단일 사용자**: 충돌 빈번 (2.33%)
- Optimistic Lock은 부하 분산 환경에서 효과적

### 3. 재시도 메커니즘의 효과
- 단일 사용자 환경에서도 97.66% 성공률 유지
- 하지만 응답 시간 급증 (재시도 오버헤드)

---

## 🔍 병목 지점

### 1. Database Connection Pool
- P95/P99 레이턴시가 높음
- 일부 요청의 응답 시간 급증 (최대 33초)
- **개선**: HikariCP maximum-pool-size 증가 (20→50)

### 2. 쿼리 성능
- 평균 응답 시간 823ms
- **개선**: Slow Query Log 활성화, 인덱스 추가

### 3. JVM GC
- 일부 요청의 응답 시간 급증
- **개선**: G1 GC 튜닝, Heap 크기 조정

### 4. Optimistic Lock 재시도
- 단일 사용자 환경에서 응답 시간 급증
- **개선**: 재시도 횟수 및 Backoff 시간 조정

---

## 💡 개선 권장 사항

### 즉시 적용 (1주)
1. ✅ Connection Pool 튜닝 (maximum-pool-size: 20→50)
2. ✅ 인덱스 추가 (user_balance.user_id, version)
3. ✅ Slow Query Log 활성화

**기대 효과**: P95 30% 개선 (2.93s → 2.05s)

### 중기 적용 (1-2주)
1. ⏳ Read Replica 도입
2. ⏳ Redis 캐싱 적용
3. ⏳ JVM 튜닝

**기대 효과**: P95 72% 개선 (2.93s → 800ms), TPS 2배 증가

### 장기 적용 (1-2개월)
1. ⏳ APM 도구 도입
2. ⏳ CQRS 패턴 적용
3. ⏳ 메시지 큐 기반 비동기 처리

**기대 효과**: P95 90% 개선 (2.93s → 300ms), TPS 3배 증가

---

## 🎯 프로덕션 배포 가능 여부

### ⚠️ 조건부 배포 가능

**배포 가능한 이유**:
- ✅ 안정성(99.99%)은 프로덕션 레벨
- ✅ 동시성 제어 검증 완료
- ✅ 재시도 메커니즘 작동 확인

**배포 전 필요한 개선**:
- ⚠️ Connection Pool 튜닝 (필수)
- ⚠️ 인덱스 추가 (필수)
- ⚠️ Slow Query 최적화 (필수)
- ⚠️ P95/P99 레이턴시 개선 (권장)

**추가 검증 필요**:
1. 단기 개선 항목 적용 후 재테스트
2. 실제 프로덕션 트래픽 패턴으로 부하 테스트
3. 장애 복구 시나리오 테스트
4. 피크 타임 트래픽 대응 테스트

---

## 📚 관련 문서

- **상세 분석**: [`PERFORMANCE_REPORT.md`](./PERFORMANCE_REPORT.md) - 전체 성능 분석 보고서
- **테스트 가이드**: [`README.md`](./README.md) - K6 테스트 실행 가이드
- **검증 가이드**: [`../VERIFICATION_GUIDE.md`](../VERIFICATION_GUIDE.md) - 전체 검증 절차

---

## 📝 다음 단계

1. **즉시 적용**: Connection Pool 튜닝 및 인덱스 추가
2. **재테스트**: 개선 후 K6 부하 테스트 재실행
3. **비교 분석**: Before/After 성능 비교
4. **문서 업데이트**: 개선 효과를 문서에 반영
5. **프로덕션 배포**: 모든 검증 완료 후 배포 진행

---

**작성자**: Claude Code
**버전**: 1.0
**다음 테스트 예정일**: 단기 개선 적용 후 (1주 후)
