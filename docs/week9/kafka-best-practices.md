# Kafka Best Practices (심화)

> **목표**: STEP 17/18에서 “동작”을 넘어서, 운영 가능한 Kafka 사용 습관(멱등성/재시도/DLQ/모니터링/파티셔닝)을 체크리스트로 정리한다.

---

## 📋 목차

1. [전달 보장(Delivery)과 멱등성](#전달-보장delivery과-멱등성)
2. [파티셔닝/키 설계](#파티셔닝키-설계)
3. [재시도와 DLQ](#재시도와-dlq)
4. [컨슈머 운영(Offset/리밸런싱)](#컨슈머-운영offset리밸런싱)
5. [모니터링](#모니터링)

---

## 전달 보장(Delivery)과 멱등성

- Kafka는 보통 `at-least-once` 운영이 현실적이고, **컨슈머 멱등성**이 핵심이다.
- 멱등 키 예시
  - `eventId` (UUID)
  - `(userId, couponId)` 같은 비즈니스 유니크 조합
- 구현 예시(개념)
  - DB Unique Key로 “이미 처리됨”을 보장
  - 처리 성공 후 offset commit (또는 트랜잭션/Outbox 패턴과 결합)

---

## 파티셔닝/키 설계

- Key는 “순서가 필요한 단위”를 대표해야 한다. (예: `userId`, `orderId`, `couponId`)
- 파티션 수는 “병렬 처리 단위”다.
  - 파티션이 3개면, 컨슈머 인스턴스를 10개 띄워도 동시에 3개만 처리된다.
- 키 선택은 정렬과 핫파티션(쏠림) 사이의 트레이드오프를 문서에 남긴다.

---

## 재시도와 DLQ

- 일시 오류(Timeout/네트워크)는 재시도 대상, 영구 오류(스키마 불일치/필수 데이터 누락)는 DLQ 대상
- DLQ는 “버리는 곳”이 아니라, 재처리/원인 분석을 위한 **격리 채널**이다.
- (권장) DLQ 메시지에 포함할 정보
  - original topic/partition/offset
  - exception stacktrace 요약
  - eventId/idempotencyKey

---

## 컨슈머 운영(Offset/리밸런싱)

- Lag은 “상태”이고, 문제는 “증가 추세”와 “원인(처리 시간/오류)”이다.
- 리밸런싱은 자주 일어나면 처리 지연을 만든다.
  - 무분별한 scale up/down, 과도한 heartbeat 설정 변경을 피한다.

---

## 모니터링

- 필수
  - consumer lag
  - 처리량(TPS), 처리 지연(처리 시간)
  - 실패율(재시도 횟수/DLQ 적재량)
- (가능하면) “비즈니스 성공률”과 연결
  - 예: 쿠폰 발급 성공률, 중복 발급 방지율, 처리 완료까지의 p95

